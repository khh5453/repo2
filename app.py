# app.py
# -------------------------------------------------------------
# Pharma A/B Test Dashboard  (no scipy/statsmodels required)
# -------------------------------------------------------------

import numpy as np
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import streamlit as st
import streamlit.components.v1 as components
from math import erf, sqrt  # for normal CDF

# ------------------------
# Lightweight z-test (replace statsmodels.proportions_ztest)
# ------------------------
def proportions_ztest_light(count, nobs, alternative="two-sided"):
    x1, x2 = [float(c) for c in count]
    n1, n2 = [float(n) for n in nobs]
    if n1 <= 0 or n2 <= 0:
        return np.nan, np.nan
    p1 = x1 / n1
    p2 = x2 / n2
    p_pool = (x1 + x2) / (n1 + n2)
    denom = p_pool * (1 - p_pool) * (1.0/n1 + 1.0/n2)
    if denom <= 0:
        return np.nan, np.nan
    z = (p1 - p2) / sqrt(denom)

    def phi(t):  # standard normal CDF via erf
        return 0.5 * (1.0 + erf(t / sqrt(2.0)))

    if alternative == "two-sided":
        p = 2.0 * (1.0 - phi(abs(z)))
    elif alternative == "smaller":
        p = phi(z)
    elif alternative == "larger":
        p = 1.0 - phi(z)
    else:
        p = np.nan
    return z, p

# ------------------------
# Page & Team Info
# ------------------------
st.set_page_config(page_title="Pharma A/B test", layout="wide")
TEAM_NAME = "ÌòúÎ¶¨ÎØ∏ÏôÄ ÏπúÍµ¨Îì§"
TEAM_MEMBERS = ["ÍπÄÌòÑÌù¨", "ÏÑúÎØºÏòÅ", "Ïû•ÌòÑÏ£º", "ÏßÑÌòúÎ¶º"]

# ------------------------
# Custom Sidebar Style
# ------------------------
st.markdown(
    """
    <style>
        [data-testid="stSidebar"] {
            background-color: #FFF4EA;
        }
    </style>
    """,
    unsafe_allow_html=True
)


with st.sidebar:
    st.header("üëÅüëÑüëÅ ÌòúÎ¶¨ÎØ∏ÏôÄ ÏπúÍµ¨Îì§")
    st.sidebar.header ("**ÌåÄÏõê**")
    st.markdown("\n".join([f"- {m}" for m in TEAM_MEMBERS]))


# ------------------------
# Helpers
# ------------------------
def funnel_counts_gate(df: pd.DataFrame):
    """Gate Î∞©Ïãù (Visit Í∏∞Ï§Ä): Review/Cart/Purchase ÎèÑÎã¨ Ïàò (Ï°∞Í±¥Î∂ÄÏö©)"""
    V = len(df)
    R_mask = (df.get("scrolled_to_reviews", 0) == 1)
    R = int(R_mask.sum())
    C_mask = R_mask & (df.get("added_to_cart", 0) == 1)
    C = int(C_mask.sum())
    P_mask = C_mask & (df.get("converted", 0) == 1)
    P = int(P_mask.sum())
    return V, R, C, P

def funnel_counts(df: pd.DataFrame):
    """ÎàÑÏ†Å ÌçºÎÑê Ïπ¥Ïö¥Ìä∏ (Visit -> Review -> Cart -> Purchase)"""
    visits = len(df)
    scrolled_mask = df["scrolled_to_reviews"] == 1
    scrolled = int(scrolled_mask.sum())
    cart_mask = scrolled_mask & (df["added_to_cart"] == 1)
    added_to_cart = int(cart_mask.sum())
    purchase_mask = cart_mask & (df["converted"] == 1)
    purchased = int(purchase_mask.sum())
    return {"visits": visits, "scrolled": scrolled, "added_to_cart": added_to_cart, "purchased": purchased}

# ------------------------
# Data Load (ÏóÖÎ°úÎçî Ï†úÍ±∞, Í≥†Ï†ï ÌååÏùº)
# ------------------------
def load_data():
    for path in ["./data/pharma_ab_test_data_all_2.csv",
                 "pharma_ab_test_data_all_2.csv",
                 "pharma_ab_test_data_all.csv"]:
        try:
            return pd.read_csv(path)
        except Exception:
            continue
    st.warning("Îç∞Ïù¥ÌÑ∞ ÌååÏùºÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§. ./data/pharma_ab_test_data_all_2.csv Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.")
    st.stop()

df = load_data()

# Normalize
if "group" in df.columns:
    df["group"] = df["group"].astype(str).str.upper()
else:
    df["group"] = "A"

for c in ["scrolled_to_reviews", "added_to_cart", "converted",
          "previous_app_user", "previous_product_buyer"]:
    if c in df.columns:
        df[c] = pd.to_numeric(df[c], errors="coerce").fillna(0).astype(int)

if "pack_color" in df.columns:
    df["pack_color"] = df["pack_color"].astype(str).str.lower()

if "visit_date" in df.columns:
    df["visit_date"] = pd.to_datetime(df["visit_date"], errors="coerce")

# ------------------------
# Sidebar Filters (pack_color, group Ï†úÏô∏)
# ------------------------
st.sidebar.header("ÌïÑÌÑ∞")
if "visit_date" in df.columns and df["visit_date"].notna().any():
    min_d, max_d = df["visit_date"].min(), df["visit_date"].max()
    dr = st.sidebar.date_input("Ïã§Ìóò Í∏∞Í∞Ñ (Î∞©Î¨∏ ÏùºÏûê)", (min_d.date(), max_d.date()))
    if isinstance(dr, tuple) and len(dr) == 2:
        start, end = pd.to_datetime(dr[0]), pd.to_datetime(dr[1])
        df = df[(df["visit_date"] >= start) & (df["visit_date"] <= end)]

#(ÎØº) ÏÇ¨Ïù¥ÎìúÎ∞î ÌëúÏãú Ïù¥Î¶Ñ Îß§Ìïë
LABEL_MAP = {
    "device_type": "Í∏∞Ï¢Ö (device_type)",
    "gender": "ÏÑ±Î≥Ñ (gender)",
    "age_group": "Ïó∞Î†π Í∑∏Î£π (age_group)",
    "previous_app_user": "Í≥ºÍ±∞ Ïï± Ïù¥Ïö©Ïûê",
    "previous_product_buyer": "Í∏∞Ï°¥ Íµ¨Îß§ Í≥†Í∞ù"
}

#(ÎØº) Îã§Ï§ëÏÑ†ÌÉù ÌïÑÌÑ∞ (device_type, gender, age_group)
for col in ["device_type", "gender", "age_group"]:
    if col in df.columns:
        opts = ["(All)"] + sorted(df[col].dropna().astype(str).unique().tolist())
        sel = st.sidebar.multiselect(LABEL_MAP.get(col, col), opts, default=["(All)"])
        if sel and "(All)" not in sel:
            df = df[df[col].astype(str).isin(sel)]

#(ÎØº) Îã®ÏùºÏÑ†ÌÉù ÌïÑÌÑ∞ (previous_app_user, previous_product_buyer)
for flag in ["previous_app_user", "previous_product_buyer"]:
    if flag in df.columns:
        val = st.sidebar.selectbox(LABEL_MAP.get(flag, flag), ["(All)", "0", "1"])
        if val != "(All)":
            df = df[df[flag] == int(val)]



st.sidebar.markdown("<br>", unsafe_allow_html=True)
st.sidebar.markdown("<br>", unsafe_allow_html=True)

if "show_link" not in st.session_state:
    st.session_state.show_link = False

if st.sidebar.button("üë• Pharma_Dataset ÎßÅÌÅ¨ Î≥¥Í∏∞"):
    st.session_state.show_link = not st.session_state.show_link

if st.session_state.show_link:
    st.sidebar.markdown(
        "[üëâ Kaggle Îç∞Ïù¥ÌÑ∞ÏÖã Ïó¥Í∏∞](https://www.kaggle.com/datasets/storytellerman/pharma-ab-test-packaging-impact-in-mobile-app)"
    )

st.title("Pharma A/B Test")

# ============================================================
# Experiment Overview
# ============================================================
with st.container(border=True):
    st.header("Experiment Overview")

    nA = int((df["group"] == "A").sum())
    nB = int((df["group"] == "B").sum())
    xA = int(df.loc[df["group"] == "A", "converted"].sum()) if "converted" in df.columns else 0
    xB = int(df.loc[df["group"] == "B", "converted"].sum()) if "converted" in df.columns else 0

    left, right = st.columns([1.4, 1])
    with left:
        st.subheader("Í∑∏Î£πÎ≥Ñ Íµ¨Îß§ Ï†ÑÌôòÏú®")
        c1, c2 = st.columns(2)

        def donut_for_group(label, conv, total, conv_color):
            non_conv = max(total - conv, 0)
            pct = (conv / total) * 100 if total > 0 else 0
            fig = go.Figure([go.Pie(
                labels=["Converted", "Not converted"],
                values=[conv, non_conv],
                hole=0.62, sort=False, textinfo="none"
            )])
            fig.update_traces(
                hovertemplate="%{label}: %{value:,} (%{percent})<extra></extra>",
                marker=dict(colors=[conv_color, "#ecf0f1"])
            )
            fig.update_layout(title=f"{label}  ‚Ä¢  CR {pct:.1f}%",
                            margin=dict(l=10, r=10, t=40, b=10),
                            height=260, showlegend=False)
            fig.add_annotation(text=f"<b>{pct:.1f}%</b>", x=0.5, y=0.5,
                            showarrow=False, font=dict(size=22, color="#333"))
            return fig

        # ÏôºÏ™Ω(A) = #DC3C22, Ïò§Î•∏Ï™Ω(B) = #3D74B6
        c1.plotly_chart(donut_for_group("Group A", xA, nA, "#E78F81"),
                        use_container_width=True, key="ov_donut_A")
        c2.plotly_chart(donut_for_group("Group B", xB, nB, "#B7E0FF"),
                        use_container_width=True, key="ov_donut_B")

    with right:
        st.subheader("ÌÜµÍ≥Ñ Ïã§Ìóò Í≤∞Í≥º (A vs B)")
        if nA > 0 and nB > 0:
            pA, pB = (xA / nA), (xB / nB)
            lift_pp = (pB - pA) * 100
            z_two, p_two = proportions_ztest_light([xA, xB], [nA, nB], alternative="two-sided")
            z_one, p_one = proportions_ztest_light([xA, xB], [nA, nB], alternative="smaller")
            direction = "B > A" if pB > pA else ("A > B" if pA > pB else "A ‚âà B")

            stats_df = pd.DataFrame({
                "Group": ["A", "B", "Total"],
                "Sample (n)": [nA, nB, nA + nB],
                "Converted": [xA, xB, xA + xB],
                "CR (%)": [round(pA*100,2), round(pB*100,2), round((xA+xB)/(nA+nB)*100,2)]
            })
            st.dataframe(stats_df, use_container_width=True, hide_index=True)
            st.markdown(
                f"- **Direction:** {direction}  |  **Lift (B‚àíA):** {lift_pp:.2f} pp  \n"
                f"- **Two-sided:** z = {z_two:.2f}, p = {p_two:.4f}  \n"
                f"- **One-tailed (H‚ÇÅ: A < B):** z = {z_one:.2f}, p = {p_one:.4f}"
            )
            st.success(f"‚úÖÍ≤∞Î°†: Ï†ÑÌôòÏú® Ï∞®Ïù¥Îäî {'ÌÜµÍ≥ÑÏ†ÅÏúºÎ°ú Ïú†ÏùòÌï©ÎãàÎã§' if (not np.isnan(p_two) and p_two<0.05) else 'ÌÜµÍ≥ÑÏ†ÅÏúºÎ°ú Ïú†ÏùòÌïòÏßÄ ÏïäÏäµÎãàÎã§'}.")
        else:
            st.warning("A/B ÏÉòÌîåÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.")

    # ---------------- Overview KPI Chips (ÏßëÎã®Î≥Ñ ÏöîÏïΩ) ----------------
    need_cols = {"scrolled_to_reviews", "added_to_cart", "converted"}


    def _fmt_pct(x, nd=1):
        return "-" if pd.isna(x) else f"{x * 100:.{nd}f}%"


    def _width(x):
        if pd.isna(x): return 0
        x = max(0.0, min(1.0, float(x)))
        return int(round(x * 100))


    if need_cols.issubset(df.columns):
        # HTML + CSS (components.html Î°ú ÌôïÏã§Ìûà Î†åÎçî)
        cards = []
        for g, gdf in df.groupby("group"):
            V = len(gdf)
            purchase_cr = gdf["converted"].mean() if V else np.nan
            drop_rate = (1 - purchase_cr) if not pd.isna(purchase_cr) else np.nan
            cart_rate = gdf["added_to_cart"].mean() if V else np.nan

            cards.append(f"""
            <div class="group-card">
              <div class="group-tag">Group {g}</div>
              <div class="row">
                <div class="kpi">
                  <div class="label">Ïù¥ÌÉàÎ•† (1 ‚àí Íµ¨Îß§ Ï†ÑÌôòÏú®)</div>
                  <div class="value">{_fmt_pct(drop_rate, 1)}</div>
                  <div class="bar"><div class="fill" style="width:{_width(drop_rate)}%"></div></div>
                </div>
                <div class="kpi">
                  <div class="label">Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞Ïú® (Cart / Visit)</div>
                  <div class="value">{_fmt_pct(cart_rate, 1)}</div>
                  <div class="bar"><div class="fill" style="width:{_width(cart_rate)}%"></div></div>
                </div>
              </div>
            </div>
            """)

        html = f"""
        <html>
        <head>
          <style>
            .wrap {{ display:flex; flex-direction:column; gap:14px; }}
            .section-title {{ font-weight:750; font-size:29px; color:#343A40; margin: 8px 0 4px 2px; }}  /* ‚úÖ Ï†úÎ™© Ïä§ÌÉÄÏùº */
            .group-card {{ border:1px solid #eee; border-radius:14px; padding:12px 14px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05); }}
            .group-tag {{ display:inline-block; font-size:12px; font-weight:700; color:#2f80ed; background:#e9f2ff; border-radius:999px; padding:2px 10px; margin-bottom:8px; }}
            .row {{ display:flex; gap:12px; flex-wrap:wrap; }}
            .kpi {{ flex:1 1 240px; border:1px solid #f0f0f0; border-radius:12px; padding:12px 14px; background:#fff; }}
            .label {{ font-size:15px; color:#666; }}
            .value {{ font-weight:800; font-size:20px; color:#111; margin-top:2px; }}
            .sub {{ font-size:11px; color:#999; margin-top:4px; }}
            .bar {{ width:100%; height:8px; background:#f1f3f5; border-radius:999px; overflow:hidden; margin-top:8px; }}
            .fill {{ height:100%; background:#2f80ed; }}
          </style>
        </head>
        <body>
            <div class="wrap">
                <div class="section-title">Ïù¥ÌÉàÎ•† & Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞Ïú®</div>   <!-- ‚úÖ Ï†úÎ™© -->
                {"".join(cards)}
            </div>
            <div class="wrap" style="margin-top:5px;">
                <div class="section-title">ÌçºÎÑê Ï†ÑÌôòÏú®</div>   <!-- ‚úÖ Ï†úÎ™© -->
            </div>
        </body>
        </html>
        """
        components.html(html, height=320 + 80 * len(cards), scrolling=False)
    # =========================================
    # Compact Funnel Summary (ÌòÑÏû¨Îäî Ï∞∏Í≥†Ïö©)
    # =========================================
    stages = ["Visits", "Reviews", "Cart", "Purchase"]

    def funnel_counts2(df_in):
        visits = len(df_in)
        scrolled_mask = df_in["scrolled_to_reviews"] == 1
        scrolled = int(scrolled_mask.sum())
        cart_mask = scrolled_mask & (df_in["added_to_cart"] == 1)
        added_to_cart = int(cart_mask.sum())
        purchase_mask = cart_mask & (df_in["converted"] == 1)
        purchased = int(purchase_mask.sum())
        return [visits, scrolled, added_to_cart, purchased]

    V_A, R_A, C_A, P_A = funnel_counts2(df[df["group"]=="A"])
    V_B, R_B, C_B, P_B = funnel_counts2(df[df["group"]=="B"])
    spacer, col1, spacer2, col2, spacer3 = st.columns([0.1, 0.8, 0.3, 0.8, 0.1])

    with col1:
        figA = go.Figure(go.Funnel(
            y=stages,
            x=[V_A, R_A, C_A, P_A],
            textinfo="value+percent initial",
            marker=dict(color="#E78F81")
        ))
        figA.update_layout(title="Group A Funnel", height=300, margin=dict(l=10, r=10, t=40, b=20))
        st.plotly_chart(figA, use_container_width=True)

    with col2:
        figB = go.Figure(go.Funnel(
            y=stages,
            x=[V_B, R_B, C_B, P_B],
            textinfo="value+percent initial",
            marker=dict(color="#B7E0FF")
        ))
        figB.update_layout(title="Group B Funnel", height=300, margin=dict(l=10, r=10, t=40, b=20))
        st.plotly_chart(figB, use_container_width=True)



# ============================================================
# Guardrails ‚Äî ÎèÖÎ¶Ω Ïù¥ÌÉà(Visit Í∏∞Ï§Ä) Í∑∏ÎûòÌîÑ
# ============================================================
# Ïä§ÌÉÄÏùº ÌååÎùºÎØ∏ÌÑ∞ (Í∞ÄÎìúÎ†àÏùº ÏÑπÏÖò ÏÉÅÎã® Ï™ΩÏóê Ï∂îÍ∞Ä)
COLOR_MAP = {"A": "#E78F81",  # A = Îπ®Í∞ï
             "B": "#B7E0FF"}  # B = ÌååÎûë

TEXT_SIZE = 14        # ÎßâÎåÄ ÏúÑ Í∞í(ÌÖçÏä§Ìä∏) ÌÅ¨Í∏∞
LEGEND_SIZE = 20      # Î≤îÎ°Ä Í∏ÄÏûê ÌÅ¨Í∏∞
AXIS_TITLE_SIZE = 16  # x/y Ï∂ï Ï†úÎ™© ÌÅ¨Í∏∞
TICK_SIZE = 13        # ÎààÍ∏à Ïà´Ïûê ÌÅ¨Í∏∞
LEGEND_TITLE_SIZE = 16


with st.container(border=True):
    st.header("Í∞ÄÎìúÎ†àÏùº ÏßÄÌëú")

    if need_cols.issubset(df.columns):
        st.subheader("Î∞©Î¨∏(Visit) Í∏∞Ï§Ä ÎèÖÎ¶Ω Ïù¥ÌÉàÏûê Ïàò ¬∑ Ïù¥ÌÉàÎ•†")
        rows = []
        for g, gdf in df.groupby("group"):
            V = len(gdf)
            R = int((gdf["scrolled_to_reviews"] == 1).sum())
            C = int((gdf["added_to_cart"] == 1).sum())
            P = int((gdf["converted"] == 1).sum())

            rows += [
                {"group": g, "stage": "Review",   "drop_cnt": V - R, "drop_rate": (V - R) / V if V else np.nan},
                {"group": g, "stage": "Cart",     "drop_cnt": V - C, "drop_rate": (V - C) / V if V else np.nan},
                {"group": g, "stage": "Purchase", "drop_cnt": V - P, "drop_rate": (V - P) / V if V else np.nan},
            ]
        drop_df = pd.DataFrame(rows)
        drop_df["label"] = drop_df.apply(
            lambda r: f"{int(r.drop_cnt):,} ({r.drop_rate:.0%})" if pd.notna(r.drop_rate) else "", axis=1
        )
        fig_drop = px.bar(
            drop_df,
            x="drop_cnt",
            y="stage",
            color="group",
            barmode="group",
            text="label",
            color_discrete_map=COLOR_MAP,      # ‚¨ÖÔ∏è Ï∂îÍ∞Ä
        )
        fig_drop.update_traces(
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,           # ‚¨ÖÔ∏è ÌÖçÏä§Ìä∏(Í∞í) ÌÅ¨Í∏∞
        )
        fig_drop.update_layout(
            margin=dict(t=60, b=10),
            yaxis_title="Dropped users",
            legend=dict(
                font=dict(size=20),                 # Î≤îÎ°Ä Ìï≠Î™© Í∏ÄÏî®
                title=dict(text="group",                     # Ï†úÎ™©(ÏõêÌïòÎäî Í≤ΩÏö∞ "Í∑∏Î£π" Îì±ÏúºÎ°ú Î≥ÄÍ≤Ω Í∞ÄÎä•)
                        font=dict(size=LEGEND_TITLE_SIZE))  # ‚Üê Î≤îÎ°Ä Ï†úÎ™© Í∏ÄÏî® ÌÅ¨Í∏∞
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),        # ‚¨ÖÔ∏è Ï∂ï Ï†úÎ™© ÌÅ¨Í∏∞
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),          # ‚¨ÖÔ∏è ÎààÍ∏à Ïà´Ïûê ÌÅ¨Í∏∞
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        st.plotly_chart(fig_drop, use_container_width=True, key="guard_drop")

        # (Ï∞∏Í≥†) Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞Ïú® Í∑∏ÎûòÌîÑÎäî Ïú†ÏßÄ
        st.subheader("Ïû•Î∞îÍµ¨Îãà Îã¥Í∏∞Ïú® (Cart / Visit)")
        cart_rate_rows = []
        for g, gdf in df.groupby("group"):
            cart_rate_rows.append({"group": g, "cart_rate": (gdf["added_to_cart"].mean() if len(gdf) else np.nan)})
        fig_cart_rate = px.bar(
            pd.DataFrame(cart_rate_rows),
            x="cart_rate",
            y="group",
            text="cart_rate",
            color="group",                         # ‚¨ÖÔ∏è Ï∂îÍ∞Ä (Í∑∏Î£πÎ≥Ñ ÏÉâ/Î≤îÎ°Ä)
            color_discrete_map=COLOR_MAP,          # ‚¨ÖÔ∏è ÏÉâ Í≥†Ï†ï
        )
        fig_cart_rate.update_traces(
            texttemplate="%{text:.1%}",
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,               # ‚¨ÖÔ∏è ÌÖçÏä§Ìä∏(Í∞í) ÌÅ¨Í∏∞
        )
        fig_cart_rate.update_yaxes(tickformat=".0%")
        fig_cart_rate.update_layout(
            margin=dict(t=60, b=10),
            legend=dict(
                font=dict(size=LEGEND_SIZE),                 # Î≤îÎ°Ä Ìï≠Î™© Í∏ÄÏî®
                title=dict(text="group",                     # Ï†úÎ™©(ÏõêÌïòÎäî Í≤ΩÏö∞ "Í∑∏Î£π" Îì±ÏúºÎ°ú Î≥ÄÍ≤Ω Í∞ÄÎä•)
                        font=dict(size=LEGEND_TITLE_SIZE))  # ‚Üê Î≤îÎ°Ä Ï†úÎ™© Í∏ÄÏî® ÌÅ¨Í∏∞
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),        # ‚¨ÖÔ∏è Ï∂ï Ï†úÎ™© ÌÅ¨Í∏∞
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),          # ‚¨ÖÔ∏è ÎààÍ∏à Ïà´Ïûê ÌÅ¨Í∏∞
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        fig_cart_rate.update_layout(margin=dict(t=60, b=10))
        st.plotly_chart(fig_cart_rate, use_container_width=True, key="guard_cart_rate")
    else:
        st.info("Í∞ÄÎìúÎ†àÏùº Í≥ÑÏÇ∞Ïóê ÌïÑÏöîÌïú Ïª¨ÎüºÏù¥ ÏóÜÏäµÎãàÎã§.")



# ============================================================
# ÏÑúÌè¨Ìä∏ ÏßÄÌëú ‚Äî Î¶¨Î∑∞ ÌÉêÏÉâÎπÑÏú® ‚Üí ÌçºÎÑêÎ≥Ñ Ï†ÑÌôòÏú® ‚Üí Sankey (Í∑∏ÎûòÌîÑ Ïú†ÏßÄ)
# ============================================================
with st.container(border=True):
    st.header("ÏÑúÌè¨Ìä∏ ÏßÄÌëú")

    # 1) Î¶¨Î∑∞ ÌÉêÏÉâÎπÑÏú®
    if "scrolled_to_reviews" in df.columns:
        st.subheader("Î¶¨Î∑∞ ÌÉêÏÉâÎπÑÏú® (Review reach / Visit)")
        rr_rows = []
        for g, gdf in df.groupby("group"):
            V = len(gdf)
            rr_rows.append({"group": g, "review_rate": (gdf["scrolled_to_reviews"].mean() if V else np.nan)})
        rr_df = pd.DataFrame(rr_rows)
        fig_rr = px.bar(
            rr_df,
            x="review_rate",
            y="group",
            text="review_rate",
            color="group",                       # ‚¨ÖÔ∏è Í∑∏Î£πÎ≥Ñ ÏÉâ/Î≤îÎ°Ä Ï∂îÍ∞Ä
            color_discrete_map=COLOR_MAP,        # ‚¨ÖÔ∏è A/B ÏÉâ Í≥†Ï†ï
        )
        fig_rr.update_traces(
            texttemplate="%{text:.1%}",
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,             # ‚¨ÖÔ∏è ÎßâÎåÄ ÏúÑ Í∞í ÌÅ¨Í∏∞
        )
        fig_rr.update_yaxes(tickformat=".0%")
        fig_rr.update_layout(
            margin=dict(t=40, b=10),
            legend=dict(
                font=dict(size=LEGEND_SIZE),                     # ‚¨ÖÔ∏è Î≤îÎ°Ä Ìï≠Î™© ÌÅ¨Í∏∞
                title=dict(text="group", font=dict(size=LEGEND_TITLE_SIZE))  # ‚¨ÖÔ∏è Î≤îÎ°Ä Ï†úÎ™© ÌÅ¨Í∏∞
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),         # ‚¨ÖÔ∏è Ï∂ï Ï†úÎ™© ÌÅ¨Í∏∞
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),           # ‚¨ÖÔ∏è ÎààÍ∏à Ïà´Ïûê ÌÅ¨Í∏∞
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        st.plotly_chart(fig_rr, use_container_width=True, key="support_review_rate")
    else:
        st.info("Î¶¨Î∑∞ ÌÉêÏÉâÎπÑÏú® Í≥ÑÏÇ∞Ïóê ÌïÑÏöîÌïú Ïª¨Îüº(scrolled_to_reviews)Ïù¥ ÏóÜÏäµÎãàÎã§.")

    st.markdown("---")

    # 2) ÌçºÎÑêÎ≥Ñ Ï†ÑÌôòÏú® (ÎàÑÏ†Å¬∑Visit Í∏∞Ï§Ä) ‚Äî Í∑∏ÎûòÌîÑ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
    st.subheader("ÌçºÎÑêÎ≥Ñ Ï†ÑÌôòÏú®")
    if need_cols.issubset(df.columns):
        stage_order = ["Visit", "Review", "Cart", "Purchase"]
        rows = []
        for g, gdf in df.groupby("group"):
            cnts = funnel_counts(gdf)
            V, R, C, P = cnts["visits"], cnts["scrolled"], cnts["added_to_cart"], cnts["purchased"]
            stage_counts = {"Visit": V, "Review": R, "Cart": C, "Purchase": P}
            stage_rates  = {"Visit": (V / V) if V else np.nan,
                            "Review": (R / V) if V else np.nan,
                            "Cart": (C / V) if V else np.nan,
                            "Purchase": (P / V) if V else np.nan}
            for stg in stage_order:
                rows.append({
                    "group": g, "stage": stg,
                    "rate": stage_rates[stg], "count": stage_counts[stg],
                    "label": (f"{stage_rates[stg]:.1%} ¬∑ {stage_counts[stg]:,}"
                            if pd.notna(stage_rates[stg]) else "")
                })
        fdf = pd.DataFrame(rows)
        fdf["stage"] = pd.Categorical(fdf["stage"], categories=stage_order, ordered=True)
        fig_funnel = px.bar(
            fdf,
            x="stage",
            y="rate",
            color="group",
            barmode="group",
            text="label",
            color_discrete_map=COLOR_MAP,        # ‚¨ÖÔ∏è A/B ÏÉâ Í≥†Ï†ï
        )
        fig_funnel.update_traces(
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,             # ‚¨ÖÔ∏è ÎßâÎåÄ ÏúÑ Í∞í ÌÅ¨Í∏∞
        )
        fig_funnel.update_yaxes(tickformat=".0%")
        fig_funnel.update_layout(
            margin=dict(t=60, b=10),
            legend=dict(
                font=dict(size=LEGEND_SIZE),                     # ‚¨ÖÔ∏è Î≤îÎ°Ä Ìï≠Î™© ÌÅ¨Í∏∞
                title=dict(text="group", font=dict(size=LEGEND_TITLE_SIZE))  # ‚¨ÖÔ∏è Î≤îÎ°Ä Ï†úÎ™© ÌÅ¨Í∏∞
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),         # ‚¨ÖÔ∏è Ï∂ï Ï†úÎ™© ÌÅ¨Í∏∞
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),           # ‚¨ÖÔ∏è ÎààÍ∏à Ïà´Ïûê ÌÅ¨Í∏∞
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        st.plotly_chart(fig_funnel, use_container_width=True, key="support_funnel_cum")
    else:
        st.info("ÌçºÎÑê Ï†ÑÌôòÏú® Í≥ÑÏÇ∞Ïóê ÌïÑÏöîÌïú Ïª¨ÎüºÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.")

    st.markdown("---")

    # 3) ÏÇ¨Ïö©Ïûê ÌùêÎ¶Ñ Sankey (Î∏åÎûúÏπò ÌçºÎÑê)
    # Í∏∞Î≥∏Í∞í
    SANK_LABEL_SIZE = 25
    SANK_LABEL_COLOR = "#000000"  # ÏßÑÌïú ÌöåÏÉâ(Í±∞Ïùò Í≤ÄÏ†ï)
    SANK_BG = "#FFFFFF"

    st.subheader("ÏÇ¨Ïö©Ïûê ÌùêÎ¶Ñ Sankey (Î∏åÎûúÏπò ÌçºÎÑê)")
    g_choices = sorted(df["group"].unique().tolist())
    g_sel = st.selectbox("Group for Sankey", g_choices, key="sankey_group")
    gdf = df[df["group"] == g_sel]
    if len(gdf) > 0 and need_cols.issubset(gdf.columns):
        nodes = ["Visit", "Review:Yes", "Review:No", "Cart:Yes", "Cart:No", "Purchase:Yes", "Purchase:No"]
        node_idx = {n: i for i, n in enumerate(nodes)}


        def cnt(mask):
            return int(mask.sum())


        v = len(gdf)
        rY = cnt(gdf["scrolled_to_reviews"] == 1);
        rN = v - rY
        cY = cnt(gdf["added_to_cart"] == 1);
        cN = v - cY
        pY = cnt(gdf["converted"] == 1);
        pN = v - pY

        s0, t0, v0 = [node_idx["Visit"]] * 2, [node_idx["Review:Yes"], node_idx["Review:No"]], [rY, rN]
        rY_cY = cnt((gdf["scrolled_to_reviews"] == 1) & (gdf["added_to_cart"] == 1))
        rY_cN = rY - rY_cY
        rN_cY = cnt((gdf["scrolled_to_reviews"] == 0) & (gdf["added_to_cart"] == 1))
        rN_cN = rN - rN_cY
        s1 = [node_idx["Review:Yes"], node_idx["Review:Yes"], node_idx["Review:No"], node_idx["Review:No"]]
        t1 = [node_idx["Cart:Yes"], node_idx["Cart:No"], node_idx["Cart:Yes"], node_idx["Cart:No"]]
        v1 = [rY_cY, rY_cN, rN_cY, rN_cN]
        cY_pY = cnt((gdf["added_to_cart"] == 1) & (gdf["converted"] == 1))
        cY_pN = cY - cY_pY
        cN_pY = cnt((gdf["added_to_cart"] == 0) & (gdf["converted"] == 1))
        cN_pN = cN - cN_pY
        s2 = [node_idx["Cart:Yes"], node_idx["Cart:Yes"], node_idx["Cart:No"], node_idx["Cart:No"]]
        t2 = [node_idx["Purchase:Yes"], node_idx["Purchase:No"], node_idx["Purchase:Yes"], node_idx["Purchase:No"]]
        v2 = [cY_pY, cY_pN, cN_pY, cN_pN]

        fig_s = go.Figure(data=[go.Sankey(
            node=dict(
                label=nodes,
                pad=20,
                thickness=16,
                # line=dict(color="rgba(0,0,0,0.25)", width=1),  # ÎÖ∏Îìú ÌÖåÎëêÎ¶¨ (ÏÑ†ÌÉù)
                # color="#FFFFFF"                                 # ÎÖ∏Îìú Î∞ïÏä§ Ï±ÑÏõÄÏÉâ (ÏÑ†ÌÉù)
            ),
            # ÎßÅÌÅ¨(ÌùêÎ¶Ñ) ÏÉâÏù¥ ÎÑàÎ¨¥ ÏßÑÌïòÎ©¥ ÌÖçÏä§Ìä∏ Í∞ÄÎèÖÏÑ± Îñ®Ïñ¥Ïßê ‚Üí ÏïΩÍ∞Ñ Ìà¨Î™ÖÌïòÍ≤å
            link=dict(
                source=s0 + s1 + s2,
                target=t0 + t1 + t2,
                value=v0 + v1 + v2,
                color="rgba(0,0,0,0.1)"  # ÌïÑÏöî Ïãú Îçî Ïó∞ÌïòÍ≤å Ï°∞Ï†ï
            )
        )])

        fig_s.update_layout(
            height=520,
            margin=dict(l=20, r=20, t=10, b=10),
            paper_bgcolor=SANK_BG,  # Ï†ÑÏ≤¥ Î∞∞Í≤Ω
            plot_bgcolor=SANK_BG,  # Ï∫îÎ≤ÑÏä§ Î∞∞Í≤Ω
            font=dict(size=SANK_LABEL_SIZE, color=SANK_LABEL_COLOR),  # ‚¨ÖÔ∏è Î†àÏù¥Î∏î Í∏ÄÏûê ÌÅ¨Í∏∞/ÏÉâ
        )
        st.plotly_chart(fig_s, use_container_width=True, key="sankey_branch")
    else:
        st.info("ÏÑ†ÌÉùÌïú Í∑∏Î£πÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò SankeyÏóê ÌïÑÏöîÌïú Ïª¨ÎüºÏù¥ ÏóÜÏäµÎãàÎã§.")

# ============================================================
# ÏÇ¨ÌõÑÎ∂ÑÏÑù: Calendar ‚Üí Ï°∞Í±¥Î∂Ä Íµ¨Îß§Ïú® ‚Üí ÏÑ∏Í∑∏Î®ºÌä∏Î≥Ñ Ï†ÑÌôòÏú® ‚Üí Ïû¨Íµ¨Îß§Ïú®
# ============================================================
with st.container(border=True):
    st.header("ÏÇ¨ÌõÑÎ∂ÑÏÑù")

    st.subheader("Calendar (Í∑∏Î£πÎ≥Ñ: Ïú†Ï†Ä Ïàò or Ï†ÑÌôòÏú® %)")
    if "visit_date" not in df.columns or df["visit_date"].isna().all():
        st.info("visit_date Ïª¨ÎüºÏù¥ ÏóÜÏñ¥ Îã¨Î†• Ï∞®Ìä∏Î•º Í±¥ÎÑàÎúÅÎãàÎã§.")
    else:
        df["date"] = pd.to_datetime(df["visit_date"], errors="coerce").dt.normalize()
        daily = (
            df.groupby(["date", "group"])
            .agg(count=("user_id", "size"), cr=("converted", "mean"))
            .reset_index()
        )
        months = sorted(daily["date"].dt.to_period("M").astype(str).unique().tolist())
        if months:
            msel = st.selectbox("Ïõî ÏÑ†ÌÉù", months, index=len(months)-1, key="cal_month")
            gopt = st.radio("Í∑∏Î£π", options=["ALL"] + sorted(df["group"].dropna().unique().tolist()),
                            horizontal=True, key="cal_group")
            metric = st.radio("Metric", options=["User count", "Conversion rate (%)"],
                            horizontal=True, key="cal_metric")

            def make_calendar_heatmap(dsub: pd.DataFrame, title: str, key: str, is_rate: bool):
                period = pd.Period(msel, freq="M")
                start = period.to_timestamp(how="start")
                end = period.to_timestamp(how="end")
                base = pd.DataFrame({"date": pd.date_range(start, end, freq="D")})
                val_col = "cr" if is_rate else "count"
                merged = base.merge(dsub[["date", val_col]], on="date", how="left")
                merged[val_col] = merged[val_col].fillna(0.0 if is_rate else 0)
                first_dow = start.weekday()  # Mon=0
                merged["dow"] = merged["date"].dt.weekday
                merged["week"] = ((merged["date"].dt.day - 1 + first_dow) // 7).astype(int)
                merged["day"] = merged["date"].dt.day

                pivot = merged.pivot_table(index="week", columns="dow", values=val_col, aggfunc="sum", fill_value=0)
                daynum = merged.pivot_table(index="week", columns="dow", values="day", aggfunc="first")

                for dfp in (pivot, daynum):
                    for c in range(7):
                        if c not in dfp.columns:
                            dfp[c] = np.nan if dfp is daynum else 0
                    dfp.sort_index(axis=1, inplace=True)

                z = pivot.values.astype(float)
                mask = np.isnan(daynum.values)
                z_masked = np.where(mask, np.nan, z)

                if is_rate:
                    val_text = np.where(mask, "", (z_masked * 100).round(1).astype(str) + "%")
                    colorscale = "Greens"
                else:
                    val_text = np.where(mask, "", z_masked.astype(int).astype(str))
                    colorscale = "Blues"

                day_text = np.where(np.isnan(daynum.values), "", daynum.values.astype(float).astype(int).astype(str))
                text = np.where(day_text == "", "", day_text + "<br>" + val_text)

                fig = go.Figure(data=go.Heatmap(
                    z=z_masked,
                    x=["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                    y=[f"W{i + 1}" for i in range(len(pivot.index))],
                    text=text,
                    texttemplate="%{text}",
                    hovertemplate="%{y} %{x}<br>" + ("CR: %{z:.1%}" if is_rate else "Count: %{z}") + "<extra></extra>",
                    coloraxis="coloraxis",
                    showscale=True
                ))

                fig.update_yaxes(autorange="reversed")
                fig.update_layout(
                    title=title,
                    height=420,
                    margin=dict(l=10, r=10, t=40, b=10),
                    coloraxis=dict(
                        colorscale=[
                            [0.0, "#FFFFFF"],  # ÏµúÏÜåÍ∞í ‚Üí Ìù∞ÏÉâ
                            [1.0, "#3D74B6"]  # ÏµúÎåÄÍ∞í ‚Üí ÏõêÌïòÎäî ÌååÎûë
                        ]
                    )
                )

                st.plotly_chart(fig, use_container_width=True, key=key)

            is_rate = (metric == "Conversion rate (%)")
            if gopt == "ALL":
                if is_rate:
                    dsel = df[df["date"].dt.to_period("M").astype(str) == msel] \
                            .groupby("date")["converted"].mean().reset_index(name="cr")
                else:
                    dsel = daily[daily["date"].dt.to_period("M").astype(str) == msel] \
                            .groupby("date")["count"].sum().reset_index(name="count")
                make_calendar_heatmap(dsel, f"{msel} ¬∑ Ï†ÑÏ≤¥ " + ("Ï†ÑÌôòÏú®(%)" if is_rate else "Ïú†Ï†Ä Ïàò"),
                                    key=f"cal_ALL_{msel}_{'CR' if is_rate else 'CNT'}",
                                    is_rate=is_rate)
            else:
                dsel = daily[(daily["group"] == gopt) &
                            (daily["date"].dt.to_period("M").astype(str) == msel)] \
                        [["date", "cr" if is_rate else "count"]]
                make_calendar_heatmap(dsel, f"{msel} ¬∑ Í∑∏Î£π {gopt} " + ("Ï†ÑÌôòÏú®(%)" if is_rate else "Ïú†Ï†Ä Ïàò"),
                                    key=f"cal_{gopt}_{msel}_{'CR' if is_rate else 'CNT'}",
                                    is_rate=is_rate)
        else:
            st.info("Îã¨Î†•Ïóê ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.")

    st.markdown("---")

    # ---------- Ï°∞Í±¥Î∂Ä Íµ¨Îß§Ïú® (VisitÎ∂ÄÌÑ∞) ----------
    st.subheader("Ï°∞Í±¥Î∂Ä Íµ¨Îß§Ïú® (VisitÎ∂ÄÌÑ∞)")
    if need_cols.issubset(df.columns):
        rows = []
        for g, gdf in df.groupby("group"):
            V, Rg, Cg, Pg = funnel_counts_gate(gdf)
            rows.append({"group": g, "condition": "Overall (Visit)", "rate": (gdf["converted"].mean() if V else np.nan)})
            r = (gdf["scrolled_to_reviews"] == 1)
            c = (gdf["added_to_cart"] == 1)

            def cond_rate(mask):
                s = gdf.loc[mask, "converted"]
                return np.nan if len(s) == 0 else s.mean()

            rows += [
                {"group": g, "condition": "Purchase | Review",  "rate": cond_rate(r)},
                {"group": g, "condition": "Purchase | ~Review", "rate": cond_rate(~r)},
                {"group": g, "condition": "Purchase | Cart",    "rate": cond_rate(c)},
                {"group": g, "condition": "Purchase | ~Cart",   "rate": cond_rate(~c)},
            ]

        cond_df = pd.DataFrame(rows)
        order_cond = ["Overall (Visit)", "Purchase | Review", "Purchase | ~Review",
                    "Purchase | Cart", "Purchase | ~Cart"]
        cond_df["condition"] = pd.Categorical(cond_df["condition"], categories=order_cond, ordered=True)
        fig_cond = px.bar(
            cond_df,
            x="condition",
            y="rate",
            color="group",
            barmode="group",
            text=cond_df["rate"].map(lambda v: f"{v:.1%}" if pd.notna(v) else ""),
            color_discrete_map=COLOR_MAP,  # ‚¨ÖÔ∏è A/B ÏÉâ Í≥†Ï†ï
        )
        fig_cond.update_traces(
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,        # ‚¨ÖÔ∏è ÎßâÎåÄ ÏúÑ Í∞í ÌÅ¨Í∏∞
        )
        fig_cond.update_yaxes(tickformat=".0%")
        fig_cond.update_layout(
            title="Ï°∞Í±¥Î∂Ä Íµ¨Îß§Ïú® (Ï≤´ Ìï≠Î™©: Overall(Purchase | Visit))",
            margin=dict(t=60, b=10),
            legend=dict(
                font=dict(size=LEGEND_SIZE),                             # ‚¨ÖÔ∏è Î≤îÎ°Ä Ìï≠Î™© ÌÅ¨Í∏∞
                title=dict(text="group", font=dict(size=LEGEND_TITLE_SIZE))  # ‚¨ÖÔ∏è Î≤îÎ°Ä Ï†úÎ™© ÌÅ¨Í∏∞
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        st.plotly_chart(fig_cond, use_container_width=True, key="support_cond")
    else:
        st.info("Ï°∞Í±¥Î∂Ä Íµ¨Îß§Ïú® Í≥ÑÏÇ∞Ïóê ÌïÑÏöîÌïú Ïª¨ÎüºÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.")

    st.markdown("---")

    # ÏÑ∏Í∑∏Î®ºÌä∏Î≥Ñ Ï†ÑÌôòÏú® (Ïó∞Î†π ‚Üí Í∏∞Í∏∞ ‚Üí ÏÑ±Î≥Ñ ÏàúÏÑú)
    st.subheader("ÏÑ∏Í∑∏Î®ºÌä∏Î≥Ñ Ï†ÑÌôòÏú®")
    ordered = ["age_group", "device_type", "gender"]
    seg_candidates = [c for c in ordered if c in df.columns]
    if seg_candidates:
        seg_col = st.selectbox("ÏÑ∏Í∑∏Î®ºÌä∏ ÏÑ†ÌÉù (Ïó∞Î†π ‚Üí Í∏∞Í∏∞ ‚Üí ÏÑ±Î≥Ñ)", seg_candidates, index=0, key="seg_pick")
        seg_df = (df.groupby([seg_col, "group"])["converted"]
                    .mean()
                    .reset_index()
                    .rename(columns={"converted": "cr"}))
        seg_df["label"] = seg_df["cr"].map(lambda v: f"{v:.1%}")
        fig_seg = px.bar(
            seg_df,
            x=seg_col,
            y="cr",
            color="group",
            barmode="group",
            text="label",
            color_discrete_map=COLOR_MAP,  # ‚¨ÖÔ∏è A/B ÏÉâ Í≥†Ï†ï
        )
        fig_seg.update_traces(
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,
        )
        fig_seg.update_yaxes(tickformat=".0%")
        fig_seg.update_layout(
            margin=dict(t=60, b=10),
            legend=dict(
                font=dict(size=LEGEND_SIZE),
                title=dict(text="group", font=dict(size=LEGEND_TITLE_SIZE))
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        st.plotly_chart(fig_seg, use_container_width=True, key="post_segment")
    else:
        st.info("ÏÑ∏Í∑∏Î®ºÌä∏(Ïó∞Î†π/Í∏∞Í∏∞/ÏÑ±Î≥Ñ) Ïª¨ÎüºÏù¥ ÏóÜÏñ¥ ÏÑ∏Í∑∏Î®ºÌä∏ Î∂ÑÏÑùÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§.")

    st.markdown("---")

    # Ïû¨Íµ¨Îß§Ïú® ÎπÑÍµê: ÎØ∏Íµ¨Îß§Ïûê vs Í∏∞Ï°¥ Íµ¨Îß§Ïûê (ÏßëÎã®Î≥Ñ)
    SEGMENT_COLOR_MAP = {  # ÌååÏùº ÏÉÅÎã® Í≥µÌÜµ ÏÉÅÏàò Í∑ºÏ≤òÏóê Ìïú Î≤à ÏÑ†Ïñ∏(ÏõêÌïòÎäî ÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω Í∞ÄÎä•)
        "Ïã†Í∑ú Íµ¨Îß§Ïûê": "#FFF5CD",
        "Í∏∞Ï°¥ Íµ¨Îß§Ïûê": "#FFCFB3",
    }

    st.subheader("Íµ¨Îß§Ïú® ÎπÑÍµê ‚Äî Ïã†Í∑ú Íµ¨Îß§Ïûê vs Í∏∞Ï°¥ Íµ¨Îß§Ïûê (ÏßëÎã®Î≥Ñ)")
    if "converted" in df.columns and "previous_product_buyer" in df.columns:
        comp_rows = []
        for g, gdf in df.groupby("group"):
            for seg, name in [(0, "Ïã†Í∑ú Íµ¨Îß§Ïûê"), (1, "Í∏∞Ï°¥ Íµ¨Îß§Ïûê")]:
                sub = gdf[gdf["previous_product_buyer"] == seg]
                rate = sub["converted"].mean() if len(sub) else np.nan
                comp_rows.append({"group": g, "segment": name, "rate": rate})
        comp_df = pd.DataFrame(comp_rows)
        comp_df["label"] = comp_df["rate"].map(lambda v: f"{v:.1%}" if pd.notna(v) else "")
        fig_comp = px.bar(
            comp_df,
            x="rate",
            y="group",
            color="segment",
            barmode="group",
            text="label",
            color_discrete_map=SEGMENT_COLOR_MAP,   # ‚¨ÖÔ∏è ÏÑ∏Í∑∏Î®ºÌä∏ ÏÉâ Í≥†Ï†ï(ÏÑ†ÌÉù)
            category_orders={"group": ["A", "B"]},  # ‚¨ÖÔ∏è AÍ∞Ä ÏúÑ, BÍ∞Ä ÏïÑÎûòÎ°ú Í≥†Ï†ï
        )
        fig_comp.update_traces(
            textposition="outside",
            cliponaxis=False,
            textfont_size=TEXT_SIZE,
        )
        fig_comp.update_yaxes(tickformat=".0%")
        fig_comp.update_layout(
            margin=dict(t=60, b=10),
            legend=dict(
                font=dict(size=LEGEND_SIZE),
                title=dict(text="segment", font=dict(size=LEGEND_TITLE_SIZE))  # "Íµ¨Î∂Ñ"ÏúºÎ°ú Î∞îÍøîÎèÑ Îê®
            ),
            xaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            yaxis_title_font=dict(size=AXIS_TITLE_SIZE),
            xaxis=dict(tickfont=dict(size=TICK_SIZE)),
            yaxis=dict(tickfont=dict(size=TICK_SIZE)),
        )
        st.plotly_chart(fig_comp, use_container_width=True, key="post_repurchase")
    else:
        st.info("previous_product_buyer / converted Ïª¨ÎüºÏù¥ ÏóÜÏñ¥ Ïû¨Íµ¨Îß§ ÎπÑÍµêÎ•º Í±¥ÎÑàÎúÅÎãàÎã§.")


# ============================================================
# Details & Export
# ============================================================
st.subheader("Details & Export")
show_cols = [c for c in [
    "user_id", "group", "device_type", "gender", "age_group",
    "scrolled_to_reviews", "added_to_cart", "converted",
    "time_on_page_sec", "visit_date"
] if c in df.columns]
st.dataframe(df[show_cols].head(500) if show_cols else df.head(500), use_container_width=True)

csv_bytes = df.to_csv(index=False).encode("utf-8-sig")
st.sidebar.markdown("### ÎÇ¥Î≥¥ÎÇ¥Í∏∞")
st.sidebar.download_button("‚¨áÔ∏è Download filtered CSV",
                           data=csv_bytes,
                           file_name="ab_filtered.csv",
                           mime="text/csv")

st.markdown("---")
st.caption(f"üë• {TEAM_NAME} üë• {', '.join(TEAM_MEMBERS)}")
